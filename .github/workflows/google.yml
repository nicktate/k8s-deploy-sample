# This workflow will build a docker container, publish it to Google Container Registry, and deploy it to GKE when a release is created
#
# To configure this workflow:
#
# 1. Ensure that your repository contains the necessary configuration for your Google Kubernetes Engine cluster, including deployment.yml, kustomization.yml, service.yml, etc.
#
# 2. Set up secrets in your workspace: GKE_PROJECT with the name of the project, GKE_EMAIL with the service account email, GKE_KEY with the Base64 encoded JSON service account key (https://github.com/GoogleCloudPlatform/github-actions/tree/docs/service-account-key/setup-gcloud#inputs).
#
# 3. Change the values for the GKE_ZONE, GKE_CLUSTER, IMAGE, REGISTRY_HOSTNAME and DEPLOYMENT_NAME environment variables (below).

name: Build and Deploy to GKE

on:
  push:
    branches:
    - master

# Environment variables available to all jobs and steps in this workflow
env:
  GITHUB_SHA: ${{ github.sha }
  DOKS_CLUSTER: app-exploration
  REGISTRY_HOSTNAME: registry.digitalocean.com
  REGISTRY_NAME: ntate
  IMAGE: hello-world
  HELM_REPO: helm-repository
  DEPLOYMENT_NAME: hello-world-deployment

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v2

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
  
    - name: Save DigitalOcean kubeconfig
      run: doctl kubernetes cluster kubeconfig save $DOKS_CLUSTER
      
    - name: Login to DOCR registry
      run: doctl registry login
      
    - name: Build
      run: |        
        docker build -t "$REGISTRY_HOSTNAME"/"$REGISTRY_NAME"/"$IMAGE":"$GITHUB_SHA" \
          --build-arg GITHUB_SHA="$GITHUB_SHA" \
          --build-arg GITHUB_REF="$GITHUB_REF" .

    - name: Publish
      run: |
        docker push $REGISTRY_HOSTNAME/$REGISTRY_NAME/$IMAGE:$GITHUB_SHA
        
    - name: Save and publish potential chart changes
      uses: stefanprodan/kube-tools@v1
      with:
        helmv3: 3.2.1
        run: |
           export HELM_EXPERIMENTAL_OCI=1
           helmv3 registry login registry.digitalocean.com --username ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} --password ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
           helmv3 chart save ./chart $DOCR_REGISTRY_HOSTNAME/$DOCR_REGISTRY_NAME/$HELM_REPO/$IMAGE:$GITHUB_SHA
           helmv3 chart push $DOCR_REGISTRY_HOSTNAME/$DOCR_REGISTRY_NAME/$HELM_REPO/$IMAGE:$GITHUB_SHA
    
    - name: Deploy to cluster
      uses: stefanprodan/kube-tools@v1
      with:
        kubectl: 1.18.2
        kustomize: 3.5.5
        helmv3: 3.2.1
        command: |
          export HELM_EXPERIMENTAL_OCI=1
          helmv3 chart export $DOCR_REGISTRY_HOSTNAME/$DOCR_REGISTRY_NAME/$HELM_REPO/$IMAGE:$GITHUB_SHA -d install
          if ! helmv3 status $DEPLOYMENT_NAME > /dev/null; then
            helm install $DEPLOYMENT_NAME ./install/$HELM_REPO --set image.tag=$GITHUB_SHA
          else
            helm upgrade $DEPLOYMENT_NAME ./install/$HELM_REPO --set image.tag=$GITHUB_SHA
          fi

